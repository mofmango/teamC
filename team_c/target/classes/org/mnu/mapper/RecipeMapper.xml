<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.mnu.mapper.RecipeMapper">

    <!-- 레시피 목록 + 페이징 + 검색/정렬 -->
    <select id="getList" resultType="org.mnu.domain.RecipeVO">
        SELECT *
        FROM (
            SELECT rownum rn, a.*
            FROM (
                SELECT r.*, m.username AS writerName
                FROM TBL_RECIPE r
                JOIN TBL_MEMBER m ON r.writer = m.userid
                <where>
                    <!-- 태그 필터 -->
                    <if test="tag != null and tag != ''">
                        r.bno IN (
                            SELECT bno
                            FROM TBL_RECIPE_TAG
                            WHERE tagName = #{tag}
                        )
                    </if>

                    <!-- 검색(type + keyword) -->
                    <if test="type != null and keyword != null and keyword != ''">
                        <trim prefix="AND (" suffix=")" prefixOverrides="OR">
                            <choose>
                                <!-- 제목 검색 -->
                                <when test='type == "T"'>
                                    r.title LIKE '%' || #{keyword} || '%'
                                </when>
                                <!-- 작성자 검색 -->
                                <when test='type == "W"'>
                                    m.username LIKE '%' || #{keyword} || '%'
                                </when>
                                <!-- 태그 검색 (#제거 후) -->
                                <when test='type == "G"'>
                                    r.bno IN (
                                        SELECT bno
                                        FROM TBL_RECIPE_TAG
                                        WHERE tagName LIKE '%' || LTRIM(#{keyword}, '#') || '%'
                                    )
                                </when>
                            </choose>
                        </trim>
                    </if>
                </where>

                <!-- 정렬: 좋아요순 / 최신순 -->
                <choose>
                    <when test='sort == "likes"'>
                        ORDER BY r.like_count DESC, r.bno DESC
                    </when>
                    <otherwise>
                        ORDER BY r.bno DESC
                    </otherwise>
                </choose>
            ) a
        )
        WHERE rn BETWEEN #{startRow} AND #{endRow}
    </select>

    <insert id="create">
        <selectKey keyProperty="bno" order="BEFORE" resultType="long">
            SELECT seq_recipe.nextval FROM DUAL
        </selectKey>
        INSERT INTO TBL_RECIPE (bno, title, writer, image_path, ingredients, cost, time_required)
        VALUES (
            #{bno},
            #{title},
            #{writer},
            #{image_path, jdbcType=VARCHAR},
            #{ingredients, jdbcType=CLOB},
            #{cost, jdbcType=NUMERIC},
            #{time_required, jdbcType=VARCHAR}
        )
    </insert>

    <select id="read" resultType="org.mnu.domain.RecipeVO">
        SELECT r.*, m.username as writerName
        FROM TBL_RECIPE r JOIN TBL_MEMBER m ON r.writer = m.userid
        WHERE r.bno = #{bno}
    </select>

    <update id="update">
        UPDATE TBL_RECIPE
        SET title = #{title},
            updatedate = sysdate,
            image_path = #{image_path, jdbcType=VARCHAR},
            ingredients = #{ingredients, jdbcType=CLOB},
            cost = #{cost, jdbcType=NUMERIC},
            time_required = #{time_required, jdbcType=VARCHAR}
        WHERE bno = #{bno}
    </update>

    <delete id="delete">
        DELETE FROM TBL_RECIPE WHERE bno = #{bno}
    </delete>

    <select id="getListByWriter" resultType="org.mnu.domain.RecipeVO">
        SELECT r.*, m.username as writerName
        FROM TBL_RECIPE r JOIN TBL_MEMBER m ON r.writer = m.userid
        WHERE r.writer = #{writer}
        ORDER BY r.bno DESC
    </select>

    <select id="getBookmarksByUser" resultType="org.mnu.domain.RecipeVO">
        SELECT T2.*, M.username as writerName
        FROM TBL_BOOKMARK T1
        JOIN TBL_RECIPE T2 ON T1.bno = T2.bno
        JOIN TBL_MEMBER M ON T2.writer = M.userid
        WHERE T1.userid = #{userid}
        ORDER BY T2.bno DESC
    </select>

    <select id="getLikesByUser" resultType="org.mnu.domain.RecipeVO">
        SELECT T2.*, M.username as writerName
        FROM TBL_LIKE T1
        JOIN TBL_RECIPE T2 ON T1.bno = T2.bno
        JOIN TBL_MEMBER M ON T2.writer = M.userid
        WHERE T1.userid = #{userid}
        ORDER BY T2.bno DESC
    </select>

    <update id="updateLikeCount">
        UPDATE TBL_RECIPE SET like_count = like_count + #{amount} WHERE bno = #{bno}
    </update>

    <select id="countByWriter" resultType="int">
        SELECT COUNT(*) FROM TBL_RECIPE WHERE writer = #{writer}
    </select>

    <select id="countBookmarksByUser" resultType="int">
        SELECT COUNT(*) FROM TBL_BOOKMARK WHERE userid = #{userid}
    </select>

    <select id="countLikesByUser" resultType="int">
        SELECT COUNT(*) FROM TBL_LIKE WHERE userid = #{userid}
    </select>

    <!-- ✅ 냉장고 재료 기반 추천: ingredients 컬럼 LIKE 매칭 -->
    <select id="findByIngredients" resultType="org.mnu.domain.RecipeVO">
        SELECT
            r.*,
            m.username AS writerName,
            v.match_count
        FROM
            TBL_RECIPE r
            JOIN TBL_MEMBER m ON r.writer = m.userid
            JOIN (
                SELECT
                    r2.bno,
                    COUNT(*) AS match_count
                FROM
                    TBL_RECIPE r2
                    JOIN (
                        <!-- ingredientList를 UNION ALL 로 임시 테이블처럼 만듦 -->
                        <foreach item="item" collection="ingredientList"
                                 open="" separator="UNION ALL" close="">
                            SELECT #{item} AS ing FROM DUAL
                        </foreach>
                    ) inglist
                    ON r2.ingredients LIKE '%' || inglist.ing || '%'
                GROUP BY
                    r2.bno
            ) v ON r.bno = v.bno
        ORDER BY
            v.match_count DESC,
            r.like_count DESC
    </select>

    <select id="getTotalCount" resultType="int">
        SELECT COUNT(*)
        FROM TBL_RECIPE r
        JOIN TBL_MEMBER m ON r.writer = m.userid
        <where>
            <if test="tag != null and tag != ''">
                r.bno IN (
                    SELECT bno
                    FROM TBL_RECIPE_TAG
                    WHERE tagName = #{tag}
                )
            </if>

            <if test="type != null and keyword != null and keyword != ''">
                <trim prefix="AND (" suffix=")" prefixOverrides="OR">
                    <choose>
                        <when test='type == "T"'>
                            r.title LIKE '%' || #{keyword} || '%'
                        </when>
                        <when test='type == "W"'>
                            m.username LIKE '%' || #{keyword} || '%'
                        </when>
                        <when test='type == "G"'>
                            r.bno IN (
                                SELECT bno
                                FROM TBL_RECIPE_TAG
                                WHERE tagName LIKE '%' || LTRIM(#{keyword}, '#') || '%'
                            )
                        </when>
                    </choose>
                </trim>
            </if>
        </where>
    </select>

    <!-- ========================= -->
    <!-- [마이페이지/유저페이지] 작성 레시피 페이징 -->
    <!-- ========================= -->
    <select id="getMyRecipeList" resultType="org.mnu.domain.RecipeVO">
        SELECT *
        FROM (
            SELECT rownum rn, a.*
            FROM (
                SELECT r.*, m.username AS writerName
                FROM TBL_RECIPE r
                JOIN TBL_MEMBER m ON r.writer = m.userid
                WHERE r.writer = #{writer}
                ORDER BY r.bno DESC
            ) a
        )
        WHERE rn BETWEEN #{cri.startRow} AND #{cri.endRow}
    </select>

    <!-- ========================= -->
    <!-- [마이페이지] 북마크 페이징 -->
    <!-- ========================= -->
    <select id="getMyBookmarkList" resultType="org.mnu.domain.RecipeVO">
        SELECT *
        FROM (
            SELECT rownum rn, a.*
            FROM (
                SELECT r.*, m.username AS writerName
                FROM TBL_BOOKMARK b
                JOIN TBL_RECIPE r ON b.bno = r.bno
                JOIN TBL_MEMBER m ON r.writer = m.userid
                WHERE b.userid = #{userid}
                ORDER BY r.bno DESC
            ) a
        )
        WHERE rn BETWEEN #{cri.startRow} AND #{cri.endRow}
    </select>

    <!-- ========================= -->
    <!-- [마이페이지] 좋아요 페이징 -->
    <!-- ========================= -->
    <select id="getMyLikeList" resultType="org.mnu.domain.RecipeVO">
        SELECT *
        FROM (
            SELECT rownum rn, a.*
            FROM (
                SELECT r.*, m.username AS writerName
                FROM TBL_LIKE l
                JOIN TBL_RECIPE r ON l.bno = r.bno
                JOIN TBL_MEMBER m ON r.writer = m.userid
                WHERE l.userid = #{userid}
                ORDER BY r.bno DESC
            ) a
        )
        WHERE rn BETWEEN #{cri.startRow} AND #{cri.endRow}
    </select>

</mapper>